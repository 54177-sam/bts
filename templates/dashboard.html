<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - SIBERINDO BTS</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --success-color: #27ae60;
            {% extends "base.html" %}

            {% block title %}Dashboard - SIBERINDO BTS{% endblock %}

            {% block extra_css %}
            <style>
                :root {
                    --primary-color: #2c3e50;
                    --secondary-color: #3498db;
                    --success-color: #27ae60;
                    --warning-color: #f39c12;
                    --danger-color: #e74c3c;
                }
                .health-score { font-size: 2.5rem; font-weight: bold; }
                .health-excellent { color: var(--success-color); }
                .health-good { color: #20c997; }
                .health-fair { color: var(--warning-color); }
                .health-poor { color: #fd7e14; }
                .progress { height: 8px; }
                .stat-card { transition: transform 0.2s, box-shadow 0.2s; border: none; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
                .stat-card:hover { transform: translateY(-3px); box-shadow: 0 4px 8px rgba(0,0,0,0.15); }
                .service-status { font-size: 0.85rem; border-left: 4px solid transparent; transition: all 0.3s ease; }
                .service-status.running { border-left-color: var(--success-color); }
                .service-status.stopped { border-left-color: var(--danger-color); }
                .hackrf-status-card { border-left: 4px solid; transition: all 0.3s ease; }
                .hackrf-connected { border-left-color: var(--success-color); }
                .hackrf-disconnected { border-left-color: var(--danger-color); }
                .hackrf-warning { border-left-color: var(--warning-color); }
                .card-header { background: linear-gradient(135deg, var(--primary-color), var(--secondary-color)); color: white; font-weight: 600; }
            </style>
            {% endblock %}

            {% block content %}
            <div class="container-fluid mt-4">
                <!-- System Health Score -->
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="card stat-card">
                            <div class="card-body">
                                <div class="row align-items-center">
                                    <div class="col-md-3 text-center">
                                        {% set health_class = 'health-excellent' if health_score >= 80 else 'health-good' if health_score >= 60 else 'health-fair' if health_score >= 40 else 'health-poor' %}
                                        <div class="health-score {{ health_class }}" id="healthScore">{{ health_score }}</div>
                                        <div class="text-muted">System Health Score</div>
                                        <small class="text-muted" id="lastUpdate">Last update: {{ bts_status.last_check }}</small>
                                    </div>
                                    <div class="col-md-9">
                                        <div class="row">
                                            <div class="col-md-3">
                                                <small class="text-muted">Services Running</small>
                                                <div class="progress mb-2">
                                                    <div class="progress-bar bg-success" style="width: {{ (services_running / 6) * 100 }}%" id="servicesProgress"></div>
                                                </div>
                                                <div id="servicesCount">{{ services_running }}/6 Running</div>
                                            </div>
                                            <div class="col-md-3">
                                                <small class="text-muted">HackRF Status</small>
                                                <div class="progress mb-2">
                                                    <div class="progress-bar {{ 'bg-success' if hackrf_status.connected else 'bg-danger' }}" style="width: {{ 100 if hackrf_status.connected else 0 }}%" id="hackrfProgress"></div>
                                                </div>
                                                <div id="hackrfText">{{ hackrf_status.display_text }}</div>
                                            </div>
                                            <div class="col-md-3">
                                                <small class="text-muted">CPU Usage</small>
                                                <div class="progress mb-2">
                                                    <div class="progress-bar {{ 'bg-success' if system_stats.cpu.percent < 50 else 'bg-warning' if system_stats.cpu.percent < 80 else 'bg-danger' }}" style="width: {{ system_stats.cpu.percent }}%" id="cpuProgress"></div>
                                                </div>
                                                <div id="cpuText">{{ system_stats.cpu.percent }}% Used</div>
                                            </div>
                                            <div class="col-md-3">
                                                <small class="text-muted">Memory Usage</small>
                                                <div class="progress mb-2">
                                                    <div class="progress-bar {{ 'bg-success' if system_stats.memory.percent < 50 else 'bg-warning' if system_stats.memory.percent < 80 else 'bg-danger' }}" style="width: {{ system_stats.memory.percent }}%" id="memoryProgress"></div>
                                                </div>
                                                <div id="memoryText">{{ system_stats.memory.percent }}% Used</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Quick Stats Row -->
                <div class="row mb-4">
                    <div class="col-md-4">
                        <div class="card hackrf-status-card {{ 'hackrf-connected' if hackrf_status.connected else 'hackrf-disconnected' if hackrf_status.badge_type == 'danger' else 'hackrf-warning' }} stat-card">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <h5 class="card-title mb-0"><i class="fas fa-satellite-dish me-2"></i>HackRF Status</h5>
                                    <span class="badge bg-{{ hackrf_status.badge_type }}" id="hackrfBadge">{{ hackrf_status.display_text }}</span>
                                </div>
                                <p class="text-muted small mb-3">{{ hackrf_status.description }}</p>
                                {% if hackrf_status.connected and hackrf_status.device_info %}
                                <div class="mt-3">
                                    <small class="text-muted">Device Information:</small>
                                    <div class="small mt-1">
                                        <div><strong>Board ID:</strong> <span id="hackrfBoard">{{ hackrf_status.device_info.board_id }}</span></div>
                                        <div><strong>Firmware:</strong> <span id="hackrfFirmware">{{ hackrf_status.device_info.firmware }}</span></div>
                                        {% if hackrf_status.device_info.serial %}
                                        <div><strong>Serial:</strong> <span id="hackrfSerial">{{ hackrf_status.device_info.serial }}</span></div>
                                        {% endif %}
                                    </div>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Additional dashboard sections (services, BTS list, recent SMS, etc.) -->
                {% include 'dashboard_sections.html' ignore missing %}

            </div>
            {% endblock %}

            {% block extra_js %}
            <script>
            // Minimal dashboard JS placeholder - full interactive scripts live in template-specific blocks
            console.log('Dashboard loaded');
            </script>
            {% endblock %}
                            <div><i class="fas fa-clock me-1"></i> Uptime: <span id="systemUptime">{{ system_stats.system.uptime }}</span></div>
                            <div><i class="fas fa-users me-1"></i> Users: <span id="systemUsers">{{ system_stats.system.users }}</span></div>
                            <div><i class="fas fa-desktop me-1"></i> Platform: {{ system_stats.system.platform }}</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- BTS Statistics -->
            <div class="col-md-4">
                <div class="card stat-card">
                    <div class="card-body">
                        <h5 class="card-title mb-3">
                            <i class="fas fa-broadcast-tower me-2"></i>BTS Statistics
                        </h5>
                        <div class="row text-center mb-3">
                            <div class="col-6">
                                <div class="mb-3">
                                    <i class="fas fa-users fa-2x text-success mb-2"></i>
                                    <div class="h5 mb-0" id="subscribersCount">{{ subscribers_count }}</div>
                                    <small class="text-muted">Subscribers</small>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="mb-3">
                                    <i class="fas fa-sms fa-2x text-warning mb-2"></i>
                                    <div class="h5 mb-0" id="smsCount">{{ recent_sms }}</div>
                                    <small class="text-muted">Total SMS</small>
                                </div>
                            </div>
                        </div>
                        <div class="small text-muted">
                            <div><i class="fas fa-play-circle me-1"></i> Processes: <span id="btsProcesses">{{ bts_status.total_processes }}</span> running</div>
                            <div><i class="fas fa-check-circle me-1 text-{{ 'success' if bts_status.status == 'active' else 'danger' }}"></i> 
                                Status: <span id="btsStatus">{{ bts_status.status|title }}</span>
                            </div>
                            <div><i class="fas fa-sync-alt me-1"></i> Last check: {{ bts_status.last_check }}</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Services Status -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card stat-card">
                    <div class="card-header">
                        <div class="d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">SIBERINDO Services Status</h5>
                            <span class="badge bg-{{ 'success' if services_running >= 4 else 'warning' if services_running >= 2 else 'danger' }}">
                                {{ services_running }}/6 Services Running
                            </span>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="row" id="servicesContainer">
                            {% for service_key, service in services.items() %}
                            <div class="col-md-6 col-lg-4 mb-3">
                                <div class="d-flex justify-content-between align-items-center p-3 border rounded service-status {{ service.status }}">
                                    <div>
                                        <strong>{{ service.name }}</strong>
                                        <div class="text-muted small">{{ service.description }}</div>
                                    </div>
                                    <div class="text-end">
                                        <span class="badge bg-{{ 'success' if service.status == 'running' else 'danger' }} service-badge">
                                            {{ service.status.title() }}
                                        </span>
                                        <div class="text-muted small">Port: {{ service.port }}</div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-body text-center">
                        <button class="btn btn-outline-primary refresh-btn me-2" onclick="refreshDashboard()" id="refreshBtn">
                            <i class="fas fa-sync-alt me-1"></i>Refresh Dashboard
                        </button>
                        <button class="btn btn-outline-info me-2" onclick="detectHackRF()" id="detectBtn">
                            <i class="fas fa-satellite-dish me-1"></i>Detect HackRF
                        </button>
                        <button class="btn btn-outline-success me-2" onclick="startAllServices()">
                            <i class="fas fa-play-circle me-1"></i>Start All Services
                        </button>
                        <button class="btn btn-outline-warning" onclick="stopAllServices()">
                            <i class="fas fa-stop-circle me-1"></i>Stop All Services
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap & jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
    let autoRefreshInterval;
    let isRefreshing = false;

    function refreshDashboard() {
        if (isRefreshing) return;
        
        isRefreshing = true;
        const btn = $('#refreshBtn');
        const originalHtml = btn.html();
        
        btn.html('<i class="fas fa-spinner fa-spin me-1"></i>Refreshing...');
        btn.prop('disabled', true);

        fetch('/api/dashboard/refresh')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    updateDashboard(data);
                    showAlert('Dashboard updated successfully', 'success');
                } else {
                    showAlert('Error refreshing dashboard: ' + data.error, 'danger');
                }
            })
            .catch(error => {
                console.error('Error refreshing dashboard:', error);
                showAlert('Network error refreshing dashboard', 'danger');
            })
            .finally(() => {
                btn.html(originalHtml);
                btn.prop('disabled', false);
                isRefreshing = false;
            });
    }

    function updateDashboard(data) {
        // Update health score
        $('#healthScore').text(data.health_score).addClass('value-updated');
        
        // Update services
        $('#servicesCount').text(data.services_running + '/6 Running').addClass('value-updated');
        $('#servicesProgress').css('width', (data.services_running / 6) * 100 + '%');
        
        // Update HackRF
        $('#hackrfText').text(data.hackrf_status.display_text).addClass('value-updated');
        $('#hackrfBadge').removeClass().addClass('badge bg-' + data.hackrf_status.badge_type)
                        .text(data.hackrf_status.display_text);
        $('#hackrfProgress').css('width', data.hackrf_status.connected ? '100%' : '0%')
                           .removeClass().addClass('progress-bar ' + (data.hackrf_status.connected ? 'bg-success' : 'bg-danger'));
        
        // Update system stats
        $('#cpuPercent').text(data.system_stats.cpu.percent + '%').addClass('value-updated');
        $('#cpuProgress').css('width', data.system_stats.cpu.percent + '%')
                        .removeClass().addClass('progress-bar ' + 
                            (data.system_stats.cpu.percent < 50 ? 'bg-success' : 
                             data.system_stats.cpu.percent < 80 ? 'bg-warning' : 'bg-danger'));
        
        $('#memoryPercent').text(data.system_stats.memory.percent + '%').addClass('value-updated');
        $('#memoryProgress').css('width', data.system_stats.memory.percent + '%')
                           .removeClass().addClass('progress-bar ' + 
                               (data.system_stats.memory.percent < 50 ? 'bg-success' : 
                                data.system_stats.memory.percent < 80 ? 'bg-warning' : 'bg-danger'));
        
        // Update BTS stats
        $('#subscribersCount').text(data.subscribers_count).addClass('value-updated');
        $('#btsProcesses').text(data.bts_status.total_processes).addClass('value-updated');
        $('#btsStatus').text(data.bts_status.status.charAt(0).toUpperCase() + data.bts_status.status.slice(1))
                      .removeClass().addClass('text-' + (data.bts_status.status === 'active' ? 'success' : 'danger'));
        
        // Update timestamp
        $('#lastUpdate').text('Last update: ' + data.timestamp);
        
        // Remove animation class after animation completes
        setTimeout(() => {
            $('.value-updated').removeClass('value-updated');
        }, 1000);
    }

    function detectHackRF() {
        const btn = $('#detectBtn');
        const originalHtml = btn.html();
        
        btn.html('<i class="fas fa-spinner fa-spin me-1"></i>Detecting...');
        btn.prop('disabled', true);

        fetch('/api/hackrf/detect')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    refreshDashboard();
                    showAlert('HackRF detection completed: ' + data.hackrf_status.display_text, 'success');
                } else {
                    showAlert('HackRF detection failed: ' + data.error, 'danger');
                }
            })
            .catch(error => {
                console.error('Error detecting HackRF:', error);
                showAlert('Network error detecting HackRF', 'danger');
            })
            .finally(() => {
                btn.html(originalHtml);
                btn.prop('disabled', false);
            });
    }

    function startAllServices() {
        showAlert('Starting all services...', 'info');
        // Implementation would go here
    }

    function stopAllServices() {
        showAlert('Stopping all services...', 'warning');
        // Implementation would go here
    }

    function showAlert(message, type) {
        const alertDiv = $(`
            <div class="alert alert-${type} alert-dismissible fade show position-fixed" 
                 style="top: 80px; right: 20px; z-index: 1050; min-width: 300px;">
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        `);
        
        $('body').append(alertDiv);
        
        setTimeout(() => {
            alertDiv.alert('close');
        }, 5000);
    }

    // Auto-refresh every 30 seconds
    function startAutoRefresh() {
        autoRefreshInterval = setInterval(refreshDashboard, 30000);
    }

    // Initialize dashboard
    $(document).ready(function() {
        console.log('SIBERINDO BTS Dashboard initialized');
        startAutoRefresh();
        
        // Initial timestamp
        $('#lastUpdate').text('Last update: ' + new Date().toLocaleTimeString());
    });

    // Cleanup on page unload
    $(window).on('beforeunload', function() {
        if (autoRefreshInterval) {
            clearInterval(autoRefreshInterval);
        }
    });
    </script>
</body>
</html>